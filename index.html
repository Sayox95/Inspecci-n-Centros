<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inspección de Centros</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
body {
    font-family: Arial, sans-serif;
    padding: 10px;
    margin: 0;
}

/* Hacer que el mapa y el formulario sean responsivos */
#map {
    height: 400px;
    width: 100%;
    max-width: 100%;
}

/* Contenedor flexible para los datos del formulario */
.info-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Se adapta al tamaño de la pantalla */
    gap: 10px;
    text-align: center;
}

/* Ajuste para los elementos del formulario */
.info-box {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-weight: bold;
    width: 100%;
}

/* Asegurar que los inputs y selects sean responsivos */
.info-box input,
.info-box select,
.info-box textarea {
    width: 90%;
    max-width: 300px;
    padding: 8px;
    font-size: 16px;
}

/* Botones responsivos */
button {
    padding: 10px;
    font-size: 16px;
    cursor: pointer;
    width: 100%;
    max-width: 300px;
}

/* Hacer que el formulario sea más legible en móviles */
@media screen and (max-width: 600px) {
    .info-container {
        grid-template-columns: 1fr; /* Una sola columna en pantallas pequeñas */
    }

    #map {
        height: 300px; /* Reducir altura del mapa en móviles */
    }

    h2, h3 {
        text-align: center;
    }
}
    </style>
</head>
<body>
    <h2>Inspección de Centros</h2>
<div id="leyenda" style="display: flex; align-items: center; gap: 20px; margin-bottom: 10px;">
    <div style="display: flex; align-items: center;">
        <img src="https://maps.google.com/mapfiles/ms/icons/blue-dot.png" width="20" height="20" alt="Pendiente">
        <span style="margin-left: 5px;">Pendiente</span>
    </div>
    <div style="display: flex; align-items: center;">
        <img src="https://maps.google.com/mapfiles/ms/icons/green-dot.png" width="20" height="20" alt="Inspeccionado">
        <span style="margin-left: 5px;">Inspeccionado</span>
    </div>
</div>
    <div id="map"></div>
    <form id="formulario">
        <h3>Formulario de Inspección</h3>
        <div class="info-container">
            <div class="info-box">
                <label>Nombre del Centro</label>
                <input type="text" id="nombre_centro" readonly>
            </div>
            <div class="info-box">
                <label>CV</label>
                <input type="text" id="cv" readonly>
            </div>
            <div class="info-box">
                <label>Circuito</label>
                <input type="text" id="circuito" readonly>
            </div>
            <div class="info-box">
                <label>Municipio</label>
                <input type="text" id="municipio" readonly>
            </div>
            <div class="info-box">
                <label>Sector Electoral</label>
                <input type="text" id="sector_electoral" readonly>
            </div>
        </div>
        <br>
        <label>Latitud Original:</label>
        <input type="text" id="latitud_original" readonly>
        <br><br>
        <label>Longitud Original:</label>
        <input type="text" id="longitud_original" readonly>
        <br><br>
        <label>Latitud Nueva:</label>
        <input type="text" id="latitud_nueva" readonly>
        <br><br>
        <label>Longitud Nueva:</label>
        <input type="text" id="longitud_nueva" readonly>
        <br><br>
        <button type="button" onclick="captarCoordenadas()">Captar coordenadas reales</button>
        <br><br>
<label>Estado del Suministro:</label>
<select id="estado_suministro">
    <option value="" selected disabled>Seleccione...</option>
    <option value="sin_conexion">Sin Conexión</option>
    <option value="ilegal">Ilegal (Conexión directa Ilegal)</option>
    <option value="legal">Conexión Legal</option>
    <option value="legal_servicio_directo">Conexión Legal (Servicio directo)</option>
</select>
<br><br>
        <label>Distancia real del apoyo al punto de medida en metros:</label>
        <input type="number" id="distancia" min="0" step="0.01">
        <br><br>
<label>Cliente dispone de base:</label>
<select id="base">
    <option value="" selected disabled>Seleccione...</option>
    <option value="si">Sí</option>
    <option value="no">No</option>
</select>
<br><br>
<label>Cliente dispone de acometida:</label>
<select id="acometida">
    <option value="" selected disabled>Seleccione...</option>
    <option value="si">Sí</option>
    <option value="no">No</option>
</select>
<br><br>
<label>Instalación Interna Lista:</label>
<select id="instalacion">
    <option value="" selected disabled>Seleccione...</option>
    <option value="si">Sí</option>
    <option value="no">No</option>
</select>
<br><br>
        <label>Observaciones Relevantes:</label>
        <textarea id="observaciones"></textarea>
        <br><br>

<!-- Input para subir imágenes -->
<label>Subir o tomar fotografías:</label>
<input type="file" id="fotos" accept="image/*"
<br><br>

<!-- Vista previa de las imágenes seleccionadas -->
<div id="previews"></div>
<br><br>
        <button type="button" onclick="guardarInspeccion()">Guardar Inspección</button>
    </form>

    <script>
        var map = L.map('map').setView([15.5, -87.5], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// Previsualizar múltiples imágenes seleccionadas
document.getElementById("fotos").addEventListener("change", function(event) {
    var files = event.target.files;
    var previewsContainer = document.getElementById("previews");
    previewsContainer.innerHTML = ""; // Limpiar previsualizaciones anteriores

    for (let i = 0; i < files.length; i++) {
        var reader = new FileReader();
        reader.onload = function(e) {
            var img = document.createElement("img");
            img.src = e.target.result;
            img.style.maxWidth = "100px";
            img.style.margin = "5px";
            img.style.border = "1px solid #ccc";
            previewsContainer.appendChild(img);
        };
        reader.readAsDataURL(files[i]);
    }
});


    var iconoNormal = L.icon({
        iconUrl: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png', // Icono azul (punto no inspeccionado)
        iconSize: [32, 32],
        iconAnchor: [16, 32]
    });

    var iconoInspeccionado = L.icon({
        iconUrl: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png', // Icono verde (punto inspeccionado)
        iconSize: [32, 32],
        iconAnchor: [16, 32]
    });

    var marcadores = {};

        var puntos = [
            { id: 1, nombre: "CEB NUESTRA SRA DE LA MERCED", cv: "5061026", circuito: "RNA385", municipio: "PUERTO CORTES", sector_electoral: "NUEVOS HORIZONTES", lat: 15.838818, lon: -87.89909 },
            { id: 2, nombre: "ESC. 4 DE JULIO", cv: "5062005", circuito: "RNA385", municipio: "PUERTO CORTES", sector_electoral: "CALAN", lat: 15.736592, lon: -87.83063 },
            { id: 3, nombre: "ESC. JOSE CECILIO DEL VALLE", cv: "16182007", circuito: "NCO364", municipio: "QUIMISTAN", sector_electoral: "LA CEIBITA", lat: 15.307345, lon: -88.252519 },
            { id: 4, nombre: "CEB MARIO MELGAR", cv: "5062010", circuito: "RNA385", municipio: "PUERTO CORTES", sector_electoral: "EL MANGO", lat: 15.758769, lon: -87.83701 },
            { id: 5, nombre: "ESC. MARIO ENRIQUE PRIETO", cv: "5062004", circuito: "TSZ224", municipio: "PUERTO CORTES", sector_electoral: "BARRA DE CHAMELECON", lat: 15.894069, lon: -87.786248 },
            { id: 6, nombre: "ESC. MIGUEL PAZ BARAHONA", cv: "16162002", circuito: "NCO364", municipio: "PETOA", sector_electoral: "EL PARAISO", lat: 15.229299, lon: -88.30049 },
            { id: 7, nombre: "ESC. MINERVA", cv: "4112008", circuito: "LEC362", municipio: "LA JIGUA", sector_electoral: "EL CAMPANARIO", lat: 15.14550785, lon: -88.72494673 },
            { id: 8, nombre: "ESC. ALONSO ALTAMIRANO", cv: "16182033", circuito: "NCO364", municipio: "QUIMISTAN", sector_electoral: "BUENA VISTA MOTAGUILLA", lat: 15.456297, lon: -88.347123 },
            { id: 9, nombre: "ESC. PATRIA", cv: "16042016", circuito: "LEC362", municipio: "AZACUALPA", sector_electoral: "CERRO GRANDE", lat: 15.39196, lon: -88.587657 },
            { id: 10, nombre: "ESC. SOTERO BARAHONA", cv: "5032023", circuito: "MAS352", municipio: "OMOA", sector_electoral: "BARRA DEL MOTAGUA", lat: 15.70943, lon: -88.206183 },
            { id: 11, nombre: "ESC. PATRIA", cv: "5032024", circuito: "MAS352", municipio: "OMOA", sector_electoral: "SAN ISIDRO", lat: 15.62169607, lon: -88.14757232 },
            { id: 12, nombre: "ESC. DIONISIO DE HERRERA", cv: "16042013", circuito: "LEC362", municipio: "AZACUALPA", sector_electoral: "EL AGUACATE", lat: 15.344155, lon: -88.672831 }
        ];

let inspeccionados = JSON.parse(localStorage.getItem("inspeccionados")) || [];

puntos.forEach(punto => {
    var icono = inspeccionados.includes(punto.cv) ? iconoInspeccionado : iconoNormal; // Si está en inspeccionados, usa el verde

    var marcador = L.marker([punto.lat, punto.lon], { icon: icono })
        .addTo(map)
        .bindPopup(`<b>${punto.nombre}</b><br><button onclick="seleccionarPunto(${punto.id})">Inspeccionar</button>`);

    marcadores[punto.cv] = marcador;
});

function seleccionarPunto(id) {
    var punto = puntos.find(p => p.id === id);
    if (punto) {
        document.getElementById("nombre_centro").value = punto.nombre;
        document.getElementById("cv").value = punto.cv;
        document.getElementById("circuito").value = punto.circuito;
        document.getElementById("municipio").value = punto.municipio;
        document.getElementById("sector_electoral").value = punto.sector_electoral;
        document.getElementById("latitud_original").value = punto.lat;
        document.getElementById("longitud_original").value = punto.lon;

        // Restablecer los campos editables del formulario
        document.getElementById("latitud_nueva").value = "";
        document.getElementById("longitud_nueva").value = "";
        document.getElementById("distancia").value = "";
        document.getElementById("observaciones").value = "";

        // Restablecer los select a la opción vacía
        document.getElementById("estado_suministro").value = "";
        document.getElementById("base").value = "";
        document.getElementById("acometida").value = "";
        document.getElementById("instalacion").value = "";

        // Mostrar el formulario
        document.getElementById("formulario").style.display = "block";
    }
}

        function captarCoordenadas() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    document.getElementById("latitud_nueva").value = position.coords.latitude;
                    document.getElementById("longitud_nueva").value = position.coords.longitude;
                }, error => {
                    alert("No se pudo obtener la ubicación: " + error.message);
                });
            } else {
                alert("Geolocalización no soportada en este navegador.");
            }
        }

var apiURL = "https://script.google.com/macros/s/AKfycbztNheEuBeShIfNJ14uqJk0VuTz6MLjZwMJ7jhPLptStg5v4akuYTWzlcZ7CHgzgx5QFg/exec";  // Reemplázalo con la URL del script de Google
var apiFotosURL = "https://script.google.com/macros/s/AKfycbzlBkJSsvbOxn1I7-buO1w0fj9nivBxsblgjkuBqPQ5zgFT_rWnOIDge-k7gd8V5dLs/exec"

function guardarInspeccion() {
    var datos = {
        nombre_centro: document.getElementById("nombre_centro").value,
        cv: document.getElementById("cv").value,
        circuito: document.getElementById("circuito").value,
        municipio: document.getElementById("municipio").value,
        sector_electoral: document.getElementById("sector_electoral").value,
        latitud_original: document.getElementById("latitud_original").value,
        longitud_original: document.getElementById("longitud_original").value,
        latitud_nueva: document.getElementById("latitud_nueva").value,
        longitud_nueva: document.getElementById("longitud_nueva").value,
        estado_suministro: document.getElementById("estado_suministro").value,
        distancia: document.getElementById("distancia").value,
        base: document.getElementById("base").value,
        acometida: document.getElementById("acometida").value,
        instalacion: document.getElementById("instalacion").value,
        observaciones: document.getElementById("observaciones").value
    };

    var fotos = document.getElementById("fotos").files;
    var promises = [];

    if (fotos.length > 0) {
        for (let i = 0; i < fotos.length; i++) {
            promises.push(new Promise((resolve, reject) => {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var base64String = e.target.result.split(",")[1]; // Extraer solo los datos
                    datos["foto_" + i] = base64String;
                    resolve();
                };
                reader.onerror = reject;
                reader.readAsDataURL(fotos[i]);
            }));
        }
    }

    Promise.all(promises) // 🔹 Esperar a que todas las imágenes sean procesadas antes de enviar
        .then(() => {
            console.log("Enviando datos a Google Sheets:", JSON.stringify(datos));

            return fetch(apiURL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(datos)
            });
        })
        .then(() => {
            console.log("Datos enviados correctamente a Google Sheets.");
            return fetch(apiFotosURL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(datos)
            });
        })
        .then(() => {
            console.log("Fotos enviadas correctamente a Google Drive.");
            alert("Guardado con éxito.");

            // 🔹 Marcar la chincheta en el mapa como inspeccionada
            var cv = document.getElementById("cv").value;
            if (marcadores[cv]) {
                marcadores[cv].setIcon(iconoInspeccionado);

                // 🔹 Guardar en localStorage que este punto fue inspeccionado
                let inspeccionados = JSON.parse(localStorage.getItem("inspeccionados")) || [];
                if (!inspeccionados.includes(cv)) {
                    inspeccionados.push(cv);
                    localStorage.setItem("inspeccionados", JSON.stringify(inspeccionados));
                }
            }

            // 🔹 Limpiar el formulario después de guardar
            document.getElementById("formulario").reset();
            document.getElementById("formulario").style.display = "none";
        })
        .catch(error => {
            console.error("Error al guardar los datos:", error);
            alert("Error al guardar los datos. Revisa la consola.");
        });
}

    </script>
</body>
</html>
