<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inspecci칩n de Centros</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
body {
    font-family: Arial, sans-serif;
    padding: 10px;
    margin: 0;
}

/* Hacer que el mapa y el formulario sean responsivos */
#map {
    height: 400px;
    width: 100%;
    max-width: 100%;
}

/* Contenedor flexible para los datos del formulario */
.info-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Se adapta al tama침o de la pantalla */
    gap: 10px;
    text-align: center;
}

/* Ajuste para los elementos del formulario */
.info-box {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-weight: bold;
    width: 100%;
}

/* Asegurar que los inputs y selects sean responsivos */
.info-box input,
.info-box select,
.info-box textarea {
    width: 90%;
    max-width: 300px;
    padding: 8px;
    font-size: 16px;
}

/* Botones responsivos */
button {
    padding: 10px;
    font-size: 16px;
    cursor: pointer;
    width: 100%;
    max-width: 300px;
}

/* Hacer que el formulario sea m치s legible en m칩viles */
@media screen and (max-width: 600px) {
    .info-container {
        grid-template-columns: 1fr; /* Una sola columna en pantallas peque침as */
    }

    #map {
        height: 300px; /* Reducir altura del mapa en m칩viles */
    }

    h2, h3 {
        text-align: center;
    }
}
    </style>
</head>
<body>
    <h2>Inspecci칩n de Centros</h2>
<div id="leyenda" style="display: flex; align-items: center; gap: 20px; margin-bottom: 10px;">
    <div style="display: flex; align-items: center;">
        <img src="https://maps.google.com/mapfiles/ms/icons/blue-dot.png" width="20" height="20" alt="Pendiente">
        <span style="margin-left: 5px;">Pendiente</span>
    </div>
    <div style="display: flex; align-items: center;">
        <img src="https://maps.google.com/mapfiles/ms/icons/green-dot.png" width="20" height="20" alt="Inspeccionado">
        <span style="margin-left: 5px;">Inspeccionado</span>
    </div>
</div>
    <div id="map"></div>
    <form id="formulario">
        <h3>Formulario de Inspecci칩n</h3>
        <div class="info-container">
            <div class="info-box">
                <label>Nombre del Centro</label>
                <input type="text" id="nombre_centro" readonly>
            </div>
            <div class="info-box">
                <label>CV</label>
                <input type="text" id="cv" readonly>
            </div>
            <div class="info-box">
                <label>Circuito</label>
                <input type="text" id="circuito" readonly>
            </div>
            <div class="info-box">
                <label>Municipio</label>
                <input type="text" id="municipio" readonly>
            </div>
            <div class="info-box">
                <label>Sector Electoral</label>
                <input type="text" id="sector_electoral" readonly>
            </div>
        </div>
        <br>
        <label>Latitud Original:</label>
        <input type="text" id="latitud_original" readonly>
        <br><br>
        <label>Longitud Original:</label>
        <input type="text" id="longitud_original" readonly>
        <br><br>
        <label>Latitud Nueva:</label>
        <input type="text" id="latitud_nueva" readonly>
        <br><br>
        <label>Longitud Nueva:</label>
        <input type="text" id="longitud_nueva" readonly>
        <br><br>
        <button type="button" onclick="captarCoordenadas()">Captar coordenadas reales</button>
        <br><br>
<label>Estado del Suministro:</label>
<select id="estado_suministro">
    <option value="" selected disabled>Seleccione...</option>
    <option value="sin_conexion">Sin Conexi칩n</option>
    <option value="ilegal">Ilegal (Conexi칩n directa Ilegal)</option>
    <option value="legal">Conexi칩n Legal</option>
    <option value="legal_servicio_directo">Conexi칩n Legal (Servicio directo)</option>
</select>
<br><br>
        <label>Distancia real del apoyo al punto de medida en metros:</label>
        <input type="number" id="distancia" min="0" step="0.01">
        <br><br>
<label>Cliente dispone de base:</label>
<select id="base">
    <option value="" selected disabled>Seleccione...</option>
    <option value="si">S칤</option>
    <option value="no">No</option>
</select>
<br><br>
<label>Cliente dispone de acometida:</label>
<select id="acometida">
    <option value="" selected disabled>Seleccione...</option>
    <option value="si">S칤</option>
    <option value="no">No</option>
</select>
<br><br>
<label>Instalaci칩n Interna Lista:</label>
<select id="instalacion">
    <option value="" selected disabled>Seleccione...</option>
    <option value="si">S칤</option>
    <option value="no">No</option>
</select>
<br><br>
        <label>Observaciones Relevantes:</label>
        <textarea id="observaciones"></textarea>
        <br><br>

<!-- Input para subir im치genes -->
<label>Subir o tomar fotograf칤as:</label>
<input type="file" id="fotos" accept="image/*" multiple>
<br><br>

<!-- Vista previa de las im치genes seleccionadas -->
<div id="previews"></div>
<br><br>
        <button type="button" onclick="guardarInspeccion()">Guardar Inspecci칩n</button>
    </form>

    <script>
        var map = L.map('map').setView([15.5, -87.5], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// Previsualizar m칰ltiples im치genes seleccionadas
document.getElementById("fotos").addEventListener("change", function(event) {
    var files = event.target.files;
    var previewsContainer = document.getElementById("previews");
    previewsContainer.innerHTML = ""; // Limpiar previsualizaciones anteriores

    for (let i = 0; i < files.length; i++) {
        var reader = new FileReader();
        reader.onload = function(e) {
            var img = document.createElement("img");
            img.src = e.target.result;
            img.style.maxWidth = "100px";
            img.style.margin = "5px";
            img.style.border = "1px solid #ccc";
            previewsContainer.appendChild(img);
        };
        reader.readAsDataURL(files[i]);
    }
});


    var iconoNormal = L.icon({
        iconUrl: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png', // Icono azul (punto no inspeccionado)
        iconSize: [32, 32],
        iconAnchor: [16, 32]
    });

    var iconoInspeccionado = L.icon({
        iconUrl: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png', // Icono verde (punto inspeccionado)
        iconSize: [32, 32],
        iconAnchor: [16, 32]
    });

    var marcadores = {};

        var puntos = [
            { id: 1, nombre: "CEB NUESTRA SRA DE LA MERCED", cv: "5061026", circuito: "RNA385", municipio: "PUERTO CORTES", sector_electoral: "NUEVOS HORIZONTES", lat: 15.838818, lon: -87.89909 },
            { id: 2, nombre: "ESC. 4 DE JULIO", cv: "5062005", circuito: "RNA385", municipio: "PUERTO CORTES", sector_electoral: "CALAN", lat: 15.736592, lon: -87.83063 },
            { id: 3, nombre: "ESC. JOSE CECILIO DEL VALLE", cv: "16182007", circuito: "NCO364", municipio: "QUIMISTAN", sector_electoral: "LA CEIBITA", lat: 15.307345, lon: -88.252519 },
            { id: 4, nombre: "CEB MARIO MELGAR", cv: "5062010", circuito: "RNA385", municipio: "PUERTO CORTES", sector_electoral: "EL MANGO", lat: 15.758769, lon: -87.83701 },
            { id: 5, nombre: "ESC. MARIO ENRIQUE PRIETO", cv: "5062004", circuito: "TSZ224", municipio: "PUERTO CORTES", sector_electoral: "BARRA DE CHAMELECON", lat: 15.894069, lon: -87.786248 },
            { id: 6, nombre: "ESC. MIGUEL PAZ BARAHONA", cv: "16162002", circuito: "NCO364", municipio: "PETOA", sector_electoral: "EL PARAISO", lat: 15.229299, lon: -88.30049 },
            { id: 7, nombre: "ESC. MINERVA", cv: "4112008", circuito: "LEC362", municipio: "LA JIGUA", sector_electoral: "EL CAMPANARIO", lat: 15.14550785, lon: -88.72494673 },
            { id: 8, nombre: "ESC. ALONSO ALTAMIRANO", cv: "16182033", circuito: "NCO364", municipio: "QUIMISTAN", sector_electoral: "BUENA VISTA MOTAGUILLA", lat: 15.456297, lon: -88.347123 },
            { id: 9, nombre: "ESC. PATRIA", cv: "16042016", circuito: "LEC362", municipio: "AZACUALPA", sector_electoral: "CERRO GRANDE", lat: 15.39196, lon: -88.587657 },
            { id: 10, nombre: "ESC. SOTERO BARAHONA", cv: "5032023", circuito: "MAS352", municipio: "OMOA", sector_electoral: "BARRA DEL MOTAGUA", lat: 15.70943, lon: -88.206183 },
            { id: 11, nombre: "ESC. PATRIA", cv: "5032024", circuito: "MAS352", municipio: "OMOA", sector_electoral: "SAN ISIDRO", lat: 15.62169607, lon: -88.14757232 },
            { id: 12, nombre: "ESC. DIONISIO DE HERRERA", cv: "16042013", circuito: "LEC362", municipio: "AZACUALPA", sector_electoral: "EL AGUACATE", lat: 15.344155, lon: -88.672831 }
        ];

let inspeccionados = JSON.parse(localStorage.getItem("inspeccionados")) || [];

puntos.forEach(punto => {
    var icono = inspeccionados.includes(punto.cv) ? iconoInspeccionado : iconoNormal; // Si est치 en inspeccionados, usa el verde

    var marcador = L.marker([punto.lat, punto.lon], { icon: icono })
        .addTo(map)
        .bindPopup(`<b>${punto.nombre}</b><br><button onclick="seleccionarPunto(${punto.id})">Inspeccionar</button>`);

    marcadores[punto.cv] = marcador;
});

function seleccionarPunto(id) {
    var punto = puntos.find(p => p.id === id);
    if (punto) {
        document.getElementById("nombre_centro").value = punto.nombre;
        document.getElementById("cv").value = punto.cv;
        document.getElementById("circuito").value = punto.circuito;
        document.getElementById("municipio").value = punto.municipio;
        document.getElementById("sector_electoral").value = punto.sector_electoral;
        document.getElementById("latitud_original").value = punto.lat;
        document.getElementById("longitud_original").value = punto.lon;

        // Restablecer los campos editables del formulario
        document.getElementById("latitud_nueva").value = "";
        document.getElementById("longitud_nueva").value = "";
        document.getElementById("distancia").value = "";
        document.getElementById("observaciones").value = "";

        // Restablecer los select a la opci칩n vac칤a
        document.getElementById("estado_suministro").value = "";
        document.getElementById("base").value = "";
        document.getElementById("acometida").value = "";
        document.getElementById("instalacion").value = "";

        // Mostrar el formulario
        document.getElementById("formulario").style.display = "block";
    }
}

        function captarCoordenadas() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    document.getElementById("latitud_nueva").value = position.coords.latitude;
                    document.getElementById("longitud_nueva").value = position.coords.longitude;
                }, error => {
                    alert("No se pudo obtener la ubicaci칩n: " + error.message);
                });
            } else {
                alert("Geolocalizaci칩n no soportada en este navegador.");
            }
        }

var apiURL = "https://script.google.com/macros/s/AKfycbztNheEuBeShIfNJ14uqJk0VuTz6MLjZwMJ7jhPLptStg5v4akuYTWzlcZ7CHgzgx5QFg/exec";  // Reempl치zalo con la URL del script de Google
var apiFotosURL = "https://script.google.com/macros/s/AKfycbzlBkJSsvbOxn1I7-buO1w0fj9nivBxsblgjkuBqPQ5zgFT_rWnOIDge-k7gd8V5dLs/exec"

var imagenesSeleccionadas = []; // 游댳 Array global para almacenar im치genes seleccionadas

document.getElementById("fotos").addEventListener("change", function(event) {
    var archivos = event.target.files;
    var previewsContainer = document.getElementById("previews");

    let promises = []; // Para asegurarnos de que todas las im치genes se procesen correctamente

    for (let i = 0; i < archivos.length; i++) {
        let file = archivos[i];
        let reader = new FileReader();

        promises.push(new Promise((resolve, reject) => {
            reader.onload = function(e) {
                let base64Image = e.target.result.split(",")[1];

                // 游댳 Verificar si la imagen ya existe en `imagenesSeleccionadas` para evitar duplicados
                if (!imagenesSeleccionadas.includes(base64Image)) {
                    imagenesSeleccionadas.push(base64Image);

                    // 游댳 Verificar si la imagen ya est치 en la previsualizaci칩n antes de agregarla
                    let existingImages = Array.from(previewsContainer.getElementsByTagName("img")).map(img => img.src);
                    if (!existingImages.includes(e.target.result)) {
                        // 游댳 Crear imagen en la previsualizaci칩n
                        var img = document.createElement("img");
                        img.src = e.target.result;
                        img.style.maxWidth = "100px";
                        img.style.margin = "5px";
                        img.style.border = "1px solid #ccc";
                        previewsContainer.appendChild(img);
                    }
                }

                resolve();
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        }));
    }

    // 游댳 Esperar a que todas las im치genes se procesen antes de continuar
    Promise.all(promises).then(() => {
        console.log("Todas las im치genes fueron procesadas correctamente.");
    }).catch(error => {
        console.error("Error procesando im치genes:", error);
    });
});


function guardarInspeccion() {
    // 游댳 Mostrar el mensaje de carga antes de comenzar
    document.getElementById("loadingPopup").style.display = "block";

    var datos = {
        nombre_centro: document.getElementById("nombre_centro").value,
        cv: document.getElementById("cv").value,
        circuito: document.getElementById("circuito").value,
        municipio: document.getElementById("municipio").value,
        sector_electoral: document.getElementById("sector_electoral").value,
        latitud_original: document.getElementById("latitud_original").value,
        longitud_original: document.getElementById("longitud_original").value,
        latitud_nueva: document.getElementById("latitud_nueva").value,
        longitud_nueva: document.getElementById("longitud_nueva").value,
        estado_suministro: document.getElementById("estado_suministro").value,
        distancia: document.getElementById("distancia").value,
        base: document.getElementById("base").value,
        acometida: document.getElementById("acometida").value,
        instalacion: document.getElementById("instalacion").value,
        observaciones: document.getElementById("observaciones").value
    };

    // 游댳 Agregar im치genes almacenadas en `imagenesSeleccionadas` a `datos`
    if (imagenesSeleccionadas.length > 0) {
        for (let i = 0; i < imagenesSeleccionadas.length; i++) {
            datos[`foto_${i}`] = imagenesSeleccionadas[i]; // 游댳 Guardar correctamente cada imagen
        }
    }

    // 游댳 Enviar los datos a Google Sheets
    fetch(apiURL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(datos)
    })
    .then(() => {
        // 游댳 Enviar las fotos a Google Drive
        return fetch(apiFotosURL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(datos)
        });
    })
    .then(() => {
        // 游댳 Ocultar el mensaje de carga
        document.getElementById("loadingPopup").style.display = "none";

        // 游댳 Mostrar mensaje de 칠xito
        alert("Guardado con 칠xito.");

        // 游댳 Cambiar el color de la chincheta en el mapa
        var cv = document.getElementById("cv").value;
        if (marcadores[cv]) {
            marcadores[cv].setIcon(iconoInspeccionado);

            // 游댳 Guardar en localStorage que este punto fue inspeccionado
            let inspeccionados = JSON.parse(localStorage.getItem("inspeccionados")) || [];
            if (!inspeccionados.includes(cv)) {
                inspeccionados.push(cv);
                localStorage.setItem("inspeccionados", JSON.stringify(inspeccionados));
            }
        }

        // 游댳 Resetear el formulario y limpiar im치genes almacenadas
        document.getElementById("formulario").reset();
        imagenesSeleccionadas = []; // 游댳 Vaciar la lista de im치genes
        document.getElementById("fotos").value = ""; // 游댳 Resetear el input de im치genes
        document.getElementById("previews").innerHTML = ""; // 游댳 Limpiar la vista previa de im치genes

    })
    .catch(error => {
        console.error("Error al guardar los datos:", error);
        alert("Error al guardar los datos. Revisa la consola.");

        // 游댳 Ocultar el mensaje de carga en caso de error
        document.getElementById("loadingPopup").style.display = "none";
    });
}

</script>

<div id="loadingPopup" style="display: none; 
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
    background: rgba(0, 0, 0, 0.7); color: white; padding: 20px; 
    font-size: 18px; border-radius: 10px; z-index: 1000;">
    Guardando informaci칩n... Por favor, espera.
</div>

</body>
</html>
